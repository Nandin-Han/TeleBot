# Tag输入功能使用说明

## 功能概述
Tag输入功能已成功添加到Telegram Bot的项目部署流程中，允许用户在部署时指定精确的代码版本。

## 完整流程
1. **启动命令**: `/startupdate`
2. **主菜单选择**: 更新、回滚、停止
3. **环境选择**: 演示环境、生产环境  
4. **项目选择**: pd-admin、pd-api、pd-server
5. **Tag输入**: 用户输入版本标签（新增功能）
6. **确认操作**: 显示所有信息供用户确认
7. **执行部署**: 带进度条的执行过程

## Tag输入功能特性

### 1. Tag格式验证
- **格式要求**: `v主版本.次版本.修订版本`
- **有效示例**: `v1.1.3`, `v2.0.5`, `v1.12.8`
- **无效示例**: `1.1.3`, `v1.1`, `v1.1.3.4`, `latest`

### 2. 输入流程
- 在项目选择后，系统会提示用户输入Tag版本
- 用户直接发送文本消息输入tag
- 系统自动验证格式，显示验证结果

### 3. 错误处理
- 格式错误时显示详细错误信息
- 提供"重新输入"和"停止操作"选项
- 包含正确格式示例和说明

### 4. 确认界面
- 显示完整的操作信息：项目名称、环境、Tag版本、操作类型
- 清晰的确认/取消按钮
- 安全提示信息

## 技术实现

### 新增函数
1. `validate_tag_format()` - Tag格式验证
2. `handle_tag_input()` - 处理用户tag输入
3. `show_tag_input_request()` - 显示tag输入界面

### 更新函数
1. `show_confirmation()` - 添加tag参数支持
2. `execute_action()` - 包含tag信息显示
3. `execute_project_command()` - 接收tag和环境参数
4. `handle_callback_query()` - 支持重新输入tag
5. `handle_text_message()` - 集成tag输入处理

### 数据流
- Tag信息存储在用户上下文中 (`context.user_data['selected_tag']`)
- 回调数据格式：`confirm_action_environment_tag_project`
- 状态管理：`waiting_for_tag` 标志控制输入状态

## 使用示例

### 正常流程
```
用户: /startupdate
Bot: [显示主菜单: 更新/回滚/停止]
用户: 点击"更新"
Bot: [显示环境选择: 演示环境/生产环境]  
用户: 点击"生产环境"
Bot: [显示项目选择: pd-admin/pd-api/pd-server]
用户: 点击"pd-admin"
Bot: [显示tag输入界面]
用户: v1.2.3
Bot: [显示确认界面，包含所有信息]
用户: 点击"确认"
Bot: [执行部署，显示进度条和tag信息]
```

### 错误处理
```
用户: 1.2.3 (错误格式)
Bot: [显示错误信息和格式要求]
    [提供"重新输入"和"停止操作"选项]
用户: 点击"重新输入"
Bot: [重新显示tag输入界面]
用户: v1.2.3 (正确格式)
Bot: [继续到确认界面]
```

## 配置说明

### 正则表达式验证
```python
pattern = r'^v\d+\.\d+\.\d+$'
```
- `^v` : 必须以'v'开头
- `\d+` : 一个或多个数字
- `\.` : 字面点号
- `$` : 字符串结尾

### 回调数据结构
```
confirm_{action_type}_{environment}_{tag}_{project_name}
```
例如：`confirm_update_prod_v1.2.3_pd-admin`

## 注意事项

1. **Tag验证严格**: 必须完全符合格式要求，否则不允许继续
2. **状态管理**: 使用`waiting_for_tag`标志确保只在适当时候处理tag输入
3. **错误恢复**: 提供重新输入机制，避免用户重新开始整个流程
4. **信息完整性**: 确认界面显示所有关键信息，包括tag版本
5. **日志记录**: 所有tag相关操作都有详细日志记录

## 测试建议

1. 测试各种tag格式的验证
2. 测试重新输入功能
3. 测试取消操作的处理
4. 验证tag信息在整个流程中的传递
5. 确认最终执行时tag信息正确传递给命令函数
